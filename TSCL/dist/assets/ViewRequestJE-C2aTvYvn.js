import{r as i,u as J,j as e,z as he,B as o,b as n,A as l,i as xe,k as ge,C as ue,m as je,d as b,H as ye,J as ve,o as fe}from"./index-Cb3AN3R3.js";import{V as Ne}from"./ViewAttachment-DwyE4-Tj.js";import{S as we}from"./SimilarReq-CmxM2ozc.js";import{G as be}from"./GrievanceDetailsModal-Ce37D8zL.js";const _e=s=>{const{matchData:_,togglSeModal:S,dataStatus:k,worksheet:u}=s,[N,z]=i.useState([]),[g,w]=i.useState(""),j=localStorage.getItem("token"),y=J(),D=r=>{z(x=>x.includes(r)?x.filter(m=>m!==r):[...x,r])},q=async()=>{if(!g){o.error("Please select a status to update.");return}if(N.length===0){o.error("Please select at least one grievance.");return}try{const r=N.map(m=>n.post(`${l}/new-grievance/updatestatus?grievance_id=${m}`,{status:g},{headers:{Authorization:`Bearer ${j}`}}));await Promise.all(r);const x=N.map(m=>{const A=[n.post(`${l}/grievance-log/post`,{grievance_id:m,log_details:`SR: Assigned work status updated to ${g} by ${localStorage.getItem("name")}`,created_by_user:localStorage.getItem("name")},{headers:{Authorization:`Bearer ${j}`}}),n.post(`${l}/grievance-log/post`,{grievance_id:m,log_details:`SR: Worksheet Updated by ${localStorage.getItem("name")} : ${u}`,created_by_user:localStorage.getItem("name")},{headers:{Authorization:`Bearer ${j}`}}),n.post(`${l}/grievance-worksheet/post`,{grievance_id:m,worksheet_name:`SR: Worksheet Updated by ${localStorage.getItem("name")} : ${u}`,created_by_user:localStorage.getItem("name"),status:g},{headers:{Authorization:`Bearer ${j}`}})];return g==="closed"&&A.push(n.post(`${l}/new-grievance/worksheetJE?grievance_id=${m}`,{worksheet_JE:u},{headers:{Authorization:`Bearer ${j}`}}),n.post(`${l}/new-grievance/highlight?grievance_id=${m}`,{},{headers:{Authorization:`Bearer ${j}`}})),Promise.all(A)});await Promise.all(x),o.success("Status and logs updated successfully for selected grievances."),z([]),y("/requestview3")}catch(r){console.error("Error updating status or logs",r),o.error("Failed to update status and logs.")}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-25 backdrop-blur-sm flex justify-center items-center",children:e.jsxs("div",{className:"bg-white w-3/4 h-4/5 font-lexend m-2 mx-5 overflow-auto rounded-lg",children:[e.jsxs("div",{className:"flex justify-between px-5 py-3 items-center bg-gray-200",children:[e.jsx("p",{className:"text-lg font-semibold",children:"Similar Request"}),e.jsx("button",{className:"text-2xl font-bold text-gray-700",onClick:()=>{window.confirm("Are you sure you want to close?")&&S()},children:"Ã—"})]}),e.jsxs("div",{className:"p-5",children:[e.jsxs("div",{className:"mb-5 flex items-center gap-3",children:[e.jsx("p",{className:" text-gray-700",children:"Select Status:"}),e.jsxs("select",{className:"block px-3 py-1.5 border rounded-lg capitalize",value:g,onChange:r=>w(r.target.value),children:[e.jsx("option",{value:"",hidden:!0,children:"Choose Status"}),k&&k.map((r,x)=>e.jsx("option",{value:r.status_name,children:r.status_name},x))]}),e.jsx("button",{className:"px-5 py-1.5 bg-green-600 text-white text-sm rounded-md font-medium",onClick:q,children:"Update Status"})]}),_&&_.length>0?_.map((r,x)=>e.jsxs("div",{className:"border mb-4 rounded-lg p-4 shadow-sm bg-gray-50",children:[e.jsxs("div",{className:"flex items-center mb-3",children:[e.jsx("input",{type:"checkbox",className:"mr-3",checked:N.includes(r.grievance_id),onChange:()=>D(r.grievance_id)}),e.jsxs("p",{className:"text-gray-700 font-medium",children:[r.grievance_id,": ",r.dept_name," - ",r.complaint]})]}),e.jsxs("p",{className:"text-gray-600 mb-2",children:[e.jsx("strong",{children:"Current Status:"})," ",e.jsx("span",{className:"text-xs border-2 border-gray-500 px-5 text-center py-1 rounded-full capitalize",children:r.status})]}),e.jsxs("p",{className:"text-gray-600 mb-2",children:[e.jsx("strong",{children:"Description:"})," ",r.complaint_details]}),e.jsxs("p",{className:"text-gray-600 mb-2",children:[e.jsx("strong",{children:"Department:"})," ",r.dept_name]}),e.jsxs("p",{className:"text-gray-600",children:[e.jsx("strong",{children:"Date:"})," ",he(r.createdAt)]})]},x)):e.jsx("p",{className:"text-center text-gray-600 font-semibold mt-10",children:"No matching data found!"})]})]})})},Se=xe().shape({worksheet_name:ge().required("worksheet is required")}),Re=()=>{var U;const[s,_]=i.useState(null),[S,k]=i.useState(null),[u,N]=i.useState(null),[z,g]=i.useState(null),[w,j]=i.useState([]),[y,D]=i.useState([]),[q,r]=i.useState(!0),[x,m]=i.useState(null),A=ue(),[$,O]=i.useState(""),h=new URLSearchParams(A.search).get("grievanceId"),p=localStorage.getItem("token"),[P,C]=i.useState(!1),[V,H]=i.useState(!1),[K,E]=i.useState(!1),[X,B]=i.useState(null),[I,Z]=i.useState([]),[R,L]=i.useState([]),[Q,Y]=i.useState(null),[ee,se]=i.useState(null),[ae,M]=i.useState(!1),W=J(),{register:te,formState:{errors:re},handleSubmit:ie,reset:ke,setValue:ze,watch:ne}=je({resolver:fe(Se),mode:"onBlur"});i.useEffect(()=>{const a=async()=>{try{const c=await n.get(`${l}/status/getactive`,{headers:{Authorization:`Bearer ${p}`}}),d=b(c.data.data);j(d)}catch(c){m(c)}finally{r(!1)}},t=async()=>{try{const c=await n.get(`${l}/new-grievance-attachment/getattachments?grievance_id=${h}`,{headers:{Authorization:`Bearer ${p}`}}),d=b(c.data.data);k(d)}catch(c){m(c)}finally{r(!1)}},f=async()=>{try{const c=await n.get(`${l}/grievance-worksheet-attachment/getattachments?grievance_id=${h}`,{headers:{Authorization:`Bearer ${p}`}}),d=b(c.data.data);N(d)}catch(c){m(c)}finally{r(!1)}},v=async()=>{try{const c=await n.get(`${l}/grievance-log/getbyid?grievance_id=${h}`,{headers:{Authorization:`Bearer ${p}`}}),d=b(c.data.data);Z(d)}catch(c){m(c)}finally{r(!1)}};G(),a(),t(),v(),f()},[]);const G=async()=>{try{const a=await n.get(`${l}/new-grievance/getbyid?grievance_id=${h}`,{headers:{Authorization:`Bearer ${p}`}}),t=b(a.data.data);_(t);const f=await n.get(`${l}/new-grievance/filter?zone_name=${t.zone_name}&ward_name=${t.ward_name}&street_name=${t.street_name}&dept_name=${t.dept_name}&complaint=${t.complaint}`,{headers:{Authorization:`Bearer ${p}`}}),c=b(f.data.data).filter(d=>d.grievance_id!==h);D(c)}catch(a){m(a)}finally{r(!1)}},le=()=>{C(!P),B(null)},ce=()=>{W("/requestview3")},oe=()=>{E(!E)},de=a=>{const t=a.target.files,f=250*1024;if(t.length>5)o.error("Maximum 5 files allowed"),a.target.value=null;else{for(const v of t)if(v.size>f){o.error(`File ${v.name} is too large. Please upload files up to 250KB.`),a.target.value=null;return}L(t)}},me=async a=>{const t=a.worksheet_name;if(!$){o.error("Please select a status.");return}if(!t||t.trim()===""){o.error("Worksheet cannot be empty.");return}const f={worksheet_name:`WorkSheet given by ${localStorage.getItem("name")}: ${t}`,grievance_id:h,created_by_user:localStorage.getItem("name"),status:$};try{if((await n.post(`${l}/grievance-worksheet/post`,f,{headers:{Authorization:`Bearer ${p}`}})).status===200){if(o.success("Worksheet Uploaded Successfully"),await n.post(`${l}/grievance-log/post`,{grievance_id:h,log_details:`WorkSheet given by ${localStorage.getItem("name")}: ${t}`,created_by_user:localStorage.getItem("name")},{headers:{Authorization:`Bearer ${p}`}}),R.length>0)try{const d=new FormData;for(let F=0;F<R.length;F++)d.append("files",R[F]);d.append("grievance_id",h),d.append("created_by_user","admin"),(await n.post(`${l}/grievance-worksheet-attachment/post`,d,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${p}`}})).status===200&&(o.success("Attachment Uploaded Successfully"),L([]))}catch(d){console.error("Error uploading attachment",d),o.error("Error uploading attachment")}$==="closed"&&(await n.post(`${l}/new-grievance/worksheetJE?grievance_id=${h}`,{worksheet_JE:t},{headers:{Authorization:`Bearer ${p}`}}),await n.post(`${l}/new-grievance/highlight?grievance_id=${h}`,{},{headers:{Authorization:`Bearer ${p}`}})),(await n.post(`${l}/new-grievance/updatestatus?grievance_id=${h}`,{status:$},{headers:{Authorization:`Bearer ${p}`}})).status===200?(o.success("Status Updated Successfully"),await n.post(`${l}/grievance-log/post`,{grievance_id:h,log_details:`Assigned work is ${$} updated by ${localStorage.getItem("name")}`,created_by_user:localStorage.getItem("name")},{headers:{Authorization:`Bearer ${p}`}}),y.length===0?W("/requestview3"):(H(!0),Y(ne("worksheet_name")))):o.error("Failed to update status.")}else o.error("Failed to upload worksheet.")}catch(v){console.error("Error during submission",v),o.error("An error occurred during submission. Please try again.")}},T=a=>{se(a),M(!0)},pe=async()=>{try{(await n.post(`${l}/new-grievance/notify?grievance_id=${h}`,{escalation_notify_read:"yes"},{headers:{Authorization:`Bearer ${p}`}})).status===200?(o.success("Message Read!"),G()):o.error("Failed ")}catch(a){console.error("Error sending message:",a),o.error("An error occurred while sending the message.")}};return e.jsxs(i.Fragment,{children:[e.jsx("div",{className:"h-screen overflow-y-auto no-scrollbar",children:s&&s.grievance_id&&e.jsxs("div",{className:"md:mx-6 mx-2  my-5 font-lexend",children:[e.jsxs("p",{children:["Complaint Details #",s.grievance_id]}),e.jsxs("div",{className:"bg-white mt-2 pb-3",children:[e.jsx("p",{className:"px-5 py-2 text-lg",children:"Request By :"}),e.jsxs("div",{className:"flex justify-between gap-3 mx-3 my-3",children:[e.jsxs("div",{className:"col-span-4 px-5 pb-3",children:[e.jsx("p",{className:"capitalize",children:s.public_user_name}),e.jsxs("p",{children:["+91 ",s.phone]})," "]}),e.jsxs("div",{className:"flex flex-col mx-3",children:[e.jsxs("div",{className:"flex gap-3 mb-3 items-center",children:[e.jsx("p",{children:" Current Status: "}),e.jsx("span",{className:"text-sm border-2 border-gray-500 w-28 text-center py-1.5 ml-1 rounded-full capitalize",children:s.status})]}),e.jsxs("div",{className:"flex gap-3 items-center ",children:[e.jsx("p",{children:"Priority Level : "}),e.jsx("span",{className:`border w-28 rounded-full text-center py-1.5 mx-2 text-sm font-normal capitalize text-white  ${s.priority==="High"?"bg-red-500":s.priority==="Medium"?"bg-sky-500":s.priority==="Low"?"bg-green-500":""}`,children:s.priority})]})]})]}),e.jsx("hr",{}),s!=null&&s.escalation_notify&&s.escalation_notify_read==="no"?e.jsxs("div",{className:" bg-black mx-2 px-2 py-1  ",children:[e.jsx("div",{className:" flex justify-end",children:e.jsx("p",{className:"bg-red-600 text-white  w-4 h-4 text-center   text-xs ",onClick:pe,children:"X"})}),e.jsxs("p",{className:"mx-3 mb-2  text-white",children:["Notification : ",s.escalation_notify]})]}):e.jsx(e.Fragment,{}),e.jsxs("div",{className:"grid grid-cols-12 gap-2 mx-3 my-4",children:[e.jsxs("div",{className:"md:col-span-6 col-span-12 border px-2 py-3 rounded",children:[e.jsx("p",{className:"pt-2 text-lg",children:"Grievance Details"}),e.jsx("hr",{className:"my-3"}),e.jsxs("div",{className:"flex flex-col gap-3 mx-2 text-base",children:[e.jsxs("div",{className:"grid grid-cols-4",children:[e.jsx("p",{className:"col-span-2",children:"Origin "}),e.jsxs("p",{className:"col-span-2 capitalize",children:[": ",s.grievance_mode]})]}),e.jsxs("div",{className:"grid grid-cols-4",children:[e.jsx("p",{className:"col-span-2",children:"Complaint Type "}),e.jsxs("p",{className:"col-span-2 capitalize",children:[": ",s.complaint_type_title]})]}),e.jsxs("div",{className:"grid grid-cols-4",children:[e.jsx("p",{className:"col-span-2",children:"Department "}),e.jsxs("p",{className:"col-span-2 capitalize",children:[": ",s.dept_name]})]}),e.jsxs("div",{className:"grid grid-cols-4",children:[e.jsx("p",{className:"col-span-2",children:"Complaint "}),e.jsxs("p",{className:"col-span-2 capitalize",children:[": ",s.complaint]})]}),e.jsxs("div",{className:"grid grid-cols-4",children:[e.jsx("p",{className:"col-span-2",children:"Zone "}),e.jsxs("p",{className:"col-span-2 capitalize",children:[": ",s.zone_name]})]}),e.jsxs("div",{className:"grid grid-cols-4",children:[e.jsx("p",{className:"col-span-2",children:"Ward "}),e.jsxs("p",{className:"col-span-2 capitalize",children:[": ",s.ward_name]})]}),e.jsxs("div",{className:"grid grid-cols-4",children:[e.jsx("p",{className:"col-span-2",children:"Street "}),e.jsxs("p",{className:"col-span-2 capitalize",children:[": ",s.street_name]})]}),e.jsxs("div",{className:"grid grid-cols-4",children:[e.jsx("p",{className:"col-span-2",children:"Pincode "}),e.jsxs("p",{className:"col-span-2 capitalize",children:[": ",s.pincode]})]}),e.jsxs("div",{className:"grid grid-cols-4",children:[e.jsx("p",{className:"col-span-2",children:"Complaint Address: "}),e.jsx("p",{className:"col-start-1 col-span-4 mt-2 capitalize",children:s.complaintaddress})]}),e.jsxs("div",{className:"grid grid-cols-4",children:[e.jsx("p",{className:"col-span-2",children:"Description: "}),e.jsx("p",{className:"col-start-1 col-span-4 mt-2 capitalize",children:s.complaint_details})]}),S&&S.length>0&&e.jsxs("div",{className:"grid grid-cols-4",children:[e.jsx("p",{className:"col-span-2",children:"Attachment Files "}),e.jsx("div",{className:"col-start-1 col-span-4 mt-2 text-xs  ",children:S.map((a,t)=>e.jsx("button",{className:" mx-1 my-1 px-3 py-1.5 bg-gray-500 rounded-full text-white",onClick:()=>{C(!0),B(a.attachment),g("new-grievance-attachment")},children:`Attachment ${t+1}`},t))})]})]})]}),e.jsxs("div",{className:"md:col-span-6 col-span-12 border px-2 py-3 rounded ",children:[e.jsx("p",{className:"pt-2 text-lg ",children:"Similar Request"}),e.jsx("hr",{className:"my-3 w-full"}),e.jsx("div",{className:"overflow-auto no-scrollbar",children:e.jsxs("table",{className:"w-full bg-gray-200 rounded ",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"items-center mx-3 py-2 font-lexend whitespace-nowrap",children:"Grievance"}),e.jsx("th",{className:"items-center mx-3 py-2 font-lexend whitespace-nowrap",children:"Department"}),e.jsx("th",{className:"items-center mx-3 py-2 font-lexend whitespace-nowrap",children:"Origin"}),e.jsx("th",{className:"items-center mx-3 py-2 font-lexend whitespace-nowrap",children:"Date"}),e.jsx("th",{className:"items-center mx-3 py-2 font-lexend whitespace-nowrap",children:"Action"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-300",children:y&&y.length>0?y.map((a,t)=>e.jsxs("tr",{className:"border-b-2 border-gray-300",children:[e.jsx("td",{className:"text-center mx-3 py-2.5 whitespace-nowrap",onClick:()=>T(a.grievance_id),children:a.grievance_id}),e.jsx("td",{className:"text-center mx-3 py-2.5 whitespace-nowrap text-gray-600 capitalize",children:a.dept_name}),e.jsx("td",{className:"text-center mx-3 py-2.5 whitespace-nowrap text-gray-600 capitalize",children:a.grievance_mode}),e.jsx("td",{className:"text-center mx-3 py-2.5 whitespace-nowrap text-gray-600 ",children:ye(a.createdAt)}),e.jsx("td",{className:"flex justify-center mt-3",children:e.jsx(ve,{className:"text-xl",onClick:()=>T(a.grievance_id)})})]},t)):e.jsx("tr",{children:e.jsx("td",{className:"text-center py-2.5",colSpan:"5",children:"No matching data found"})})})]})})]})]}),e.jsxs("div",{className:"mx-5 mt-5",children:[e.jsx("p",{className:"text-base my-4",children:"Work Status Update :"}),e.jsxs("div",{className:"flex gap-3 items-center mx-6",children:[e.jsx("p",{children:"Status: "}),s.status&&s.status.toLowerCase()==="closed"?e.jsx("span",{className:"text-sm border-2 border-gray-500 w-28 text-center py-1.5 ml-3 rounded-full",children:"Closed"}):e.jsx("span",{className:"text-sm border-2 border-gray-500 px-3 py-0.5 rounded-full",children:e.jsxs("select",{className:"col-span-2 block px-1 py-1 text-sm text-black border rounded-lg border-none outline-none capitalize",onChange:a=>O(a.target.value),children:[e.jsx("option",{value:s.status,hidden:!0,children:s.status}),w==null?void 0:w.map((a,t)=>e.jsx("option",{value:a.status_name,children:a.status_name},t))]})})]})]}),e.jsxs("div",{className:"grid grid-cols-12 gap-2 mx-3 my-1",children:[e.jsxs("div",{className:"md:col-span-6 col-span-12 border px-2 py-3 rounded mt-8",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsx("p",{className:"mx-3",children:"Replay"})}),e.jsx("hr",{className:"my-3 w-full"}),e.jsxs("form",{onSubmit:ie(me),children:[e.jsx("textarea",{id:"worksheet_id",rows:"11",className:"w-full col-span-6 outline-none border p-2 rounded",placeholder:"Type...",...te("worksheet_name",{required:"This field is required"})}),e.jsx("p",{className:"text-red-500 text-sm mt-1",children:(U=re.worksheet_name)==null?void 0:U.message}),e.jsxs("div",{className:"md:mt-12",children:[e.jsx("input",{type:"file",id:"file",multiple:!0,accept:".jpeg, .jpg, .png",className:"py-2 px-3 outline-none border rounded",onChange:de}),e.jsx("div",{className:"flex justify-end mx-3 mt-3",children:e.jsx("button",{type:"submit",className:"text-white bg-gray-800 text-sm font-lexend rounded-full px-3 py-1.5",children:"Submit"})})]})]})]}),e.jsxs("div",{className:"md:col-span-6 col-span-12",children:[e.jsx("p",{className:"mb-2 mx-1 text-lg",children:"Complaint History"}),e.jsx("div",{className:"bg-gray-100 py-3 h-[530px]",children:e.jsxs("div",{className:"mx-8",children:[e.jsxs("p",{className:"py-3 font-semibold",children:["Complaint No ",s.grievance_id]}),e.jsxs("div",{className:"h-[380px] overflow-x-auto no-scrollbar mb-3",children:[I==null?void 0:I.slice().reverse().map((a,t)=>e.jsxs("div",{children:[e.jsx("p",{className:"py-1",children:new Date(a.createdAt).toLocaleDateString()}),e.jsxs("div",{className:"grid grid-cols-3 divide-x-2 divide-black",children:[e.jsx("p",{children:new Date(a.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})}),e.jsx("p",{className:"pl-5 col-span-2",children:a.log_details})]}),e.jsx("br",{})]},t)),e.jsx("p",{className:"py-2",children:new Date(s.createdAt).toLocaleDateString()}),e.jsxs("div",{className:"grid grid-cols-3 divide-x-2 divide-black",children:[e.jsx("p",{children:new Date(s.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})}),e.jsxs("p",{className:"pl-5 col-span-2",children:["Assigned To Particular ",s.dept_name," Department"]})]}),e.jsx("br",{}),e.jsxs("div",{className:"grid grid-cols-3 divide-x-2 divide-black",children:[e.jsx("p",{children:new Date(s.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})}),e.jsxs("p",{className:"pl-5 col-span-2",children:["Ticket Raised- ",s.grievance_id]})]}),e.jsx("br",{}),(u==null?void 0:u.length)>0&&e.jsxs("div",{className:"grid grid-cols-4",children:[e.jsx("p",{className:"col-span-2",children:"Attachment Files "}),e.jsx("div",{className:"col-start-1 col-span-4 mt-2 text-xs",children:u.map((a,t)=>e.jsx("button",{className:"mx-1 my-1 px-3 py-1.5 bg-gray-500 rounded-full text-white",onClick:()=>{C(!0),B(a.attachment),g("grievance-worksheet-attachment")},children:`Attachment ${t+1}`},t))})]})]}),e.jsx("hr",{className:"my-3"}),e.jsxs("div",{className:"md:grid md:grid-cols-3 flex border-2",children:[e.jsx("p",{className:"text-center px-3 py-1.5",children:"Status"}),e.jsx("p",{className:"text-center w-full bg-gray-800 md:col-span-2 text-white py-1.5",children:s.status})]})]})})]})]})]})]})}),P&&e.jsx(Ne,{endpoint:z,toggleModal:le,attachmentFile:X}),ae&&e.jsx(be,{grievanceId:ee,closeModal:()=>M(!1)}),V&&e.jsx(_e,{matchData:y,togglSeModal:ce,dataStatus:w,worksheet:Q}),K&&e.jsx(we,{matchData:y,togglReModal:oe})]})};export{Re as default};
